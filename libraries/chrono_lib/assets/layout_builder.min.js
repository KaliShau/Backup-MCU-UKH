document.addEventListener("DOMContentLoaded",(function(event){let count=0;document.querySelectorAll(".form_item").forEach(item=>{parseInt(item.dataset.pid)>count&&(count=parseInt(item.dataset.pid))}),document.querySelectorAll(".form_page").forEach(item=>{parseInt(item.dataset.pid)>count&&(count=parseInt(item.dataset.pid))}),count++;let initBehaviorsSelect=function(parent){parent.querySelectorAll("select[data-behaviors]").forEach(select=>{select.addEventListener("optionSelected",e=>{const xhttp=new XMLHttpRequest;xhttp.onreadystatechange=function(){if(4==this.readyState&&200==this.status){let behavior=Nui.Core.create_element(this.responseText);select.closest(".config").querySelector(".behaviors_list").append(behavior),Nui.Accordion.getInstance(select.closest(".config").querySelector(".behaviors_list")).init(),Nui_boot(behavior)}},xhttp.open("GET",document.querySelector(".form_designer").getAttribute("data-url")+"&action=layouts.load_behavior&id="+select.closest(".draggable").dataset.pid+"&behavior="+e.detail+"&type="+select.closest(".draggable").querySelector("[name$='[type]']").value+"&name="+select.closest(".draggable").querySelector("[name$='[name]']").value),xhttp.send()}),select.addEventListener("optionUnselected",e=>{select.closest(".draggable").querySelector(".behavior_config[data-type='"+e.detail+"']").remove()})})},setPageHeight=function(page){let height=0;[...page.children].filter(e=>e.matches("[data-tab]")).forEach(tab=>{tab.style.display="block !important";let dimensions=tab.getBoundingClientRect();tab.style.display="",dimensions.height>height&&(height=dimensions.height)}),[...page.children].filter(e=>e.matches("[data-tab]")).forEach(tab=>{tab.style.minHeight=height+"px"})},setPagesHeights=function(){document.querySelector(".form_designer").querySelectorAll(".page_box").forEach((page,k)=>{setPageHeight(page)})};function getStylesList(){let styles={};return document.querySelector('[data-title="Body"]').querySelectorAll('[data-title="Style"]').forEach(style=>{styles[style.getAttribute("data-pid")]=style.querySelector('input[name$="[label]"]').value}),styles}function updateStylesSelectors(){let styles=getStylesList();document.querySelectorAll("select[name*='[styles]']").forEach(selector=>{Nui.Dropdown.getInstance(selector).updateOptions(styles)}),document.querySelector('[data-title="Body"]').querySelectorAll('[data-title="Style"]').forEach(style=>{style.querySelector('input[name$="[label]"]').addEventListener("change",e=>{let styles=getStylesList();document.querySelectorAll("select[name*='[styles]']").forEach(selector=>{Nui.Dropdown.getInstance(selector).updateOptions(styles)})})})}function updatePreview(form){document.querySelector("div.form_page[data-tab='preview']").classList.add("loading"),saveform();let postBody=new FormData(form);form.querySelectorAll(".form_data")&&(form.querySelectorAll(".form_data").forEach(form_data=>{form_data.remove()}),form.querySelectorAll("[name]").forEach(input=>{input.disabled=!1}));const xhttp=new XMLHttpRequest;xhttp.onreadystatechange=function(){4==this.readyState&&200==this.status&&(document.querySelector("div.form_page[data-tab='preview']").classList.remove("loading"),document.querySelector("div.form_page[data-tab='preview']").innerHTML=this.responseText)};let link=document.querySelector(".form_designer").getAttribute("data-url")+"&action=layouts.preview";xhttp.open("POST",link),xhttp.send(postBody)}initBehaviorsSelect(document),new Nui.Draggables(".draggable.form_item",".droppable",{draggerSelector:".drag_item",sortableSelector:".draggable",onDrop:draggable=>{draggable.querySelector('[name$="[parent]"]').value=draggable.parentElement.getAttribute("data-pid"),draggable.querySelector('[name$="[section]"]').value=draggable.parentElement.getAttribute("data-section"),updatePreview(draggable.closest("form"))},onClone:draggable=>Nui.Core.create_element('<div class="nui segment bordered rounded slate bold">'+draggable.dataset.title+"</div>")}),new Nui.Draggables(".draggable.original_item",".droppable",{sortableSelector:".draggable",onDrag:()=>{Nui.Tabs.getInstance(document.querySelector(".navtabs")).toggle(document.querySelector(".navtabs").querySelector('[data-tab="body"]'))},onDrop:clone=>{const xhttp=new XMLHttpRequest;xhttp.onreadystatechange=function(){if(4==this.readyState&&200==this.status){let codePieces=this.responseText.split("\x3c!--config--\x3e"),item=Nui.Core.create_element(codePieces[0]);clone.replaceWith(item),Nui_boot(item),initBehaviorsSelect(item),count++,updatePreview(item.closest("form"))}};let link=document.querySelector(".form_designer").getAttribute("data-url")+"&action=layouts.load_element&type="+clone.dataset.type+"&name="+clone.dataset.name+"&id="+count+"&pid="+clone.closest("[data-pid]").dataset.pid;link=link+"&section="+clone.closest("[data-section]").dataset.section,xhttp.open("GET",link),xhttp.send()},onEnterDroppable:(draggable,droppable)=>{document.querySelectorAll(".form_item").forEach(item=>{item.querySelector(".actions").classList.add("invisible")})},onExitDroppable:(draggable,droppable)=>{document.querySelectorAll(".form_item").forEach(item=>{item.querySelector(".actions").classList.remove("invisible")})}}),document.addEventListener("click",(function(e){if(0===e.button&&e.target.matches(".remove_item")){let item=e.target.closest(".draggable");null!=item&&item.remove()}})),document.addEventListener("click",(function(e){if(0===e.button&&e.target.matches(".edit_item")){let item=e.target.closest(".draggable");null!=item&&item.classList.toggle("selected")}})),document.addEventListener("mouseover",(function(e){let item=e.target.closest(".form_item");null!=item&&item.querySelector(".actions").classList.remove("hidden")})),document.addEventListener("mouseout",(function(e){let item=e.target.closest(".form_item");null!=item&&item.querySelector(".actions").classList.add("hidden")})),document.addEventListener("optionSelected",e=>{if(e.target.matches("[data-formbuilder_dynamicevents]")&&(dropdown=e.target,event_name=e.detail,id=dropdown.getAttribute("data-formbuilder_dynamicevents"),!dropdown.closest("[data-pid='"+id+"']").querySelector('[data-pid="'+id+'"][data-section="'+event_name+'"]'))){let color="blue",title=event_name;dropdown.querySelector('option[value="'+event_name+'"][data-html]')&&(new_label=Nui.Core.create_element(dropdown.querySelector('option[value="'+event_name+'"][data-html]').getAttribute("data-html")),color=new_label.getAttribute("class").replace("nui label",""),title=new_label.innerText),new_event=Nui.Core.create_element('<div class="nui p1 flex vertical spaced bottom block dashed bordered rounded droppable sortable '+color+'" data-pid="'+id+'" data-section="'+event_name+'" data-title="'+title+'" style="min-height:50px;" data-hint=""></div>'),dropdown.closest("[data-pid='"+id+"']").append(new_event)}}),document.addEventListener("optionUnselected",e=>{e.target.matches("[data-formbuilder_dynamicevents]")&&(dropdown=e.target,event_name=e.detail,id=dropdown.getAttribute("data-formbuilder_dynamicevents"),dropdown.closest("[data-pid='"+id+"']").querySelector("[data-section='"+event_name+"']").remove())}),document.addEventListener("input",e=>{e.target.matches("input[name$='[label]']")&&(label=e.target,label.closest(".fields")&&label.closest(".fields").querySelector("input[name$='[fieldname]']")&&label.closest("form").hasAttribute("data-autofieldname")&&(label.closest(".fields").querySelector("input[name$='[fieldname]']").value=label.value.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/^[^a-zA-Z]+/,"").replace(/[^a-z0-9_-]+/g,"_").replace(/_+$/,"")))}),document.addEventListener("change",e=>{e.target.matches("input[name$='[pagegroup]']")&&buildPagesCount()}),document.addEventListener("input",e=>{e.target.matches("input[name$='[alias]']")&&(e.target.closest(".page_box").querySelector(".page-alias-display").innerText=e.target.value)}),document.addEventListener("click",e=>{e.target.matches(".show-settings")&&(link=e.target,link.closest(".draggable").querySelector(".settings-box")&&link.closest(".draggable").querySelector(".settings-box").classList.toggle("hidden"))}),document.addEventListener("input",e=>{e.target.matches("input[name$='[settings][name]']")&&(input=e.target,input.closest(".draggable").querySelector(".show-settings").innerText=e.target.value)}),document.querySelectorAll("[name*='[style][css]']:not(textarea[name$='[output]'])").forEach(input=>{input.value.length>0&&input.closest(".item").querySelector(".title").append(Nui.Core.create_element('<div class="nui label green">'+input.closest(".field").querySelector("small").innerHTML+"</div>"))}),document.addEventListener("change",e=>{if(e.target.matches("[name*='[style][css]']")){input=e.target;let css=[];input.closest("[data-screen]").querySelectorAll("[name*='[style][css]']:not(textarea[name$='[output]'])").forEach(property=>{property.value.length>0&&css.push(property.getAttribute("name").split("[").pop().replace(/\]/,"")+":"+property.value)}),input.closest("[data-screen]").querySelector("textarea[name$='[output]']").value=css.join(";")+";",labels=[],input.closest(".item").querySelectorAll("[name*='[style][css]']:not(textarea[name$='[output]'])").forEach(property=>{property.value.length>0&&labels.push(property.closest(".field").querySelector("small").innerHTML)}),input.closest(".item").querySelector(".title").querySelectorAll(".nui.label").forEach(label=>{label.remove()}),labels.forEach(label=>{input.closest(".item").querySelector(".title").append(Nui.Core.create_element('<div class="nui label green">'+label+"</div>"))})}}),document.addEventListener("change",e=>{e.target.matches("select[name$='[style][screen]']")&&(e.target.closest(".config").querySelectorAll("[data-screen]").forEach(element=>{element.classList.add("hidden")}),e.target.closest(".config").querySelector("[data-screen='"+e.target.value+"']").classList.remove("hidden"))}),document.addEventListener("change",e=>{e.target.matches("select[name*='[style][css]'][name$='[display]']")&&(e.target.closest(".item").querySelectorAll(".options").forEach(element=>{element.classList.add("hidden")}),e.target.closest(".item").querySelector(".options."+e.target.value+"-options")&&e.target.closest(".item").querySelector(".options."+e.target.value+"-options").classList.remove("hidden"))}),document.addEventListener("change",e=>{e.target.matches("select[name$='[child-of]']")&&(e.target.closest(".item").querySelectorAll(".child-options").forEach(element=>{element.classList.add("hidden")}),e.target.closest(".item").querySelector(".child-options."+e.target.value+"-options")&&e.target.closest(".item").querySelector(".child-options."+e.target.value+"-options").classList.remove("hidden"))}),updateStylesSelectors(),document.addEventListener("open",e=>{if(e.target.matches("select[name*='[styles]']")){let styles=getStylesList();Nui.Dropdown.getInstance(e.target).updateOptions(styles)}}),document.addEventListener("input",e=>{e.target.matches("input[name$='[label]']")&&(label=e.target,label.closest("[data-pid]").querySelector(".element_label").innerText=label.value)}),updatePreview(document.querySelector(".nui.form")),document.querySelector('[data-tab="preview"]').addEventListener("activated",e=>{updatePreview(e.target.closest("form"))}),document.addEventListener("change",e=>{e.target.closest(".config")&&e.target.closest(".draggable")&&updatePreview(e.target.closest("form"))})}));